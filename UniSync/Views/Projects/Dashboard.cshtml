@using Microsoft.AspNetCore.Identity
@using UniSync.Areas.Identity.Data
@inject UserManager<UniSyncUser> UserManager

@{
    ViewData["Title"] = "Project Dashboard";
    var user = await UserManager.GetUserAsync(User);
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="fw-bold"><i class="bi bi-graph-up me-2 text-primary"></i>@ViewData["Title"]</h1>
        <p class="text-muted">Welcome, @user.FirstName @user.LastName</p>
    </div>
    <div>
        <a asp-action="Index" class="btn btn-outline-primary me-2">
            <i class="bi bi-kanban me-2"></i>Projects List
        </a>
        <a asp-action="Create" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Create New
        </a>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-4 fw-bold text-primary mb-2">@ViewBag.TotalProjects</div>
                <div class="text-muted">Total Projects</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-4 fw-bold text-success mb-2">@ViewBag.CompletedProjects</div>
                <div class="text-muted">Completed</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-4 fw-bold text-primary mb-2">@ViewBag.InProgressProjects</div>
                <div class="text-muted">In Progress</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-4 fw-bold text-warning mb-2">@ViewBag.OnHoldProjects</div>
                <div class="text-muted">On Hold</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">Project Status</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Completed</span>
                        <span>@ViewBag.CompletedProjects / @ViewBag.TotalProjects</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: @(ViewBag.TotalProjects > 0 ? (ViewBag.CompletedProjects * 100 / ViewBag.TotalProjects) : 0)%;"
                             aria-valuenow="@ViewBag.CompletedProjects" aria-valuemin="0" aria-valuemax="@ViewBag.TotalProjects"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>In Progress</span>
                        <span>@ViewBag.InProgressProjects / @ViewBag.TotalProjects</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-primary" role="progressbar"
                             style="width: @(ViewBag.TotalProjects > 0 ? (ViewBag.InProgressProjects * 100 / ViewBag.TotalProjects) : 0)%;"
                             aria-valuenow="@ViewBag.InProgressProjects" aria-valuemin="0" aria-valuemax="@ViewBag.TotalProjects"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Not Started</span>
                        <span>@ViewBag.NotStartedProjects / @ViewBag.TotalProjects</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-secondary" role="progressbar"
                             style="width: @(ViewBag.TotalProjects > 0 ? (ViewBag.NotStartedProjects * 100 / ViewBag.TotalProjects) : 0)%;"
                             aria-valuenow="@ViewBag.NotStartedProjects" aria-valuemin="0" aria-valuemax="@ViewBag.TotalProjects"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>On Hold</span>
                        <span>@ViewBag.OnHoldProjects / @ViewBag.TotalProjects</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-warning" role="progressbar"
                             style="width: @(ViewBag.TotalProjects > 0 ? (ViewBag.OnHoldProjects * 100 / ViewBag.TotalProjects) : 0)%;"
                             aria-valuenow="@ViewBag.OnHoldProjects" aria-valuemin="0" aria-valuemax="@ViewBag.TotalProjects"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">Project Priority</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>High Priority</span>
                        <span>@ViewBag.HighPriorityProjects / @ViewBag.TotalProjects</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-danger" role="progressbar"
                             style="width: @(ViewBag.TotalProjects > 0 ? (ViewBag.HighPriorityProjects * 100 / ViewBag.TotalProjects) : 0)%;"
                             aria-valuenow="@ViewBag.HighPriorityProjects" aria-valuemin="0" aria-valuemax="@ViewBag.TotalProjects"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Medium Priority</span>
                        <span>@ViewBag.MediumPriorityProjects / @ViewBag.TotalProjects</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-warning" role="progressbar"
                             style="width: @(ViewBag.TotalProjects > 0 ? (ViewBag.MediumPriorityProjects * 100 / ViewBag.TotalProjects) : 0)%;"
                             aria-valuenow="@ViewBag.MediumPriorityProjects" aria-valuemin="0" aria-valuemax="@ViewBag.TotalProjects"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Low Priority</span>
                        <span>@ViewBag.LowPriorityProjects / @ViewBag.TotalProjects</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: @(ViewBag.TotalProjects > 0 ? (ViewBag.LowPriorityProjects * 100 / ViewBag.TotalProjects) : 0)%;"
                             aria-valuenow="@ViewBag.LowPriorityProjects" aria-valuemin="0" aria-valuemax="@ViewBag.TotalProjects"></div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Average Progress</span>
                        <span>@Math.Round(ViewBag.AverageProgress, 1)%</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar @(ViewBag.AverageProgress >= 75 ? "bg-success" : ViewBag.AverageProgress >= 50 ? "bg-info" : ViewBag.AverageProgress >= 25 ? "bg-warning" : "bg-danger")"
                             role="progressbar" style="width: @ViewBag.AverageProgress%;"
                             aria-valuenow="@ViewBag.AverageProgress" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">Upcoming Deadlines</h5>
            </div>
            <div class="card-body">
                @if (ViewBag.UpcomingDeadlines.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Subject</th>
                                    <th>Deadline</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var project in ViewBag.UpcomingDeadlines)
                                {
                                    <tr>
                                        <td>@project.Title</td>
                                        <td>@project.Subject.Title</td>
                                        <td>
                                            @if (project.Deadline.HasValue)
                                            {
                                                var daysLeft = (project.Deadline.Value - DateTime.Now).Days;
                                                var textClass = daysLeft <= 3 ? "text-danger" : daysLeft <= 7 ? "text-warning" : "text-muted";
                                                <span class="@textClass">
                                                    @project.Deadline.Value.ToString("dd.MM.yyyy")
                                                    (@daysLeft days left)
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            @{
                                                var statusBadgeClass = project.Status switch
                                                {
                                                    "Not Started" => "bg-secondary",
                                                    "In Progress" => "bg-primary",
                                                    "On Hold" => "bg-warning",
                                                    "Completed" => "bg-success",
                                                    _ => "bg-secondary"
                                                };
                                            }
                                            <span class="badge @statusBadgeClass">@project.Status</span>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 10px; width: 100px;">
                                                <div class="progress-bar @(project.Progress == 100 ? "bg-success" : "")" role="progressbar" style="width: @project.Progress%;" aria-valuenow="@project.Progress" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            <small>@project.Progress%</small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a asp-action="Edit" asp-route-id="@project.Id" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <a asp-action="Details" asp-route-id="@project.Id" class="btn btn-sm btn-outline-secondary">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>No upcoming deadlines found.
                    </div>
                }
            </div>
        </div>
    </div>
</div>